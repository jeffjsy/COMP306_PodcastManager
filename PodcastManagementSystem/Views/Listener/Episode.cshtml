@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Linq
@model PodcastManagementSystem.Models.Episode
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = Model.Title;
    var currentUserId = UserManager.GetUserId(User);
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<h1>@Model.Title</h1>
<h2>Podcast: @Model.Podcast.Title</h2>
<p class="text-muted">Host: @Model.Podcast.CreatorID</p>
<p>Released: @Model.ReleaseDate.ToShortDateString() | Duration: @Model.DurationMinutes min | Plays: @Model.PlayCount</p>

<div class="audio-player card p-3 mb-4">
    <h3 class="card-title">Listen Now</h3>
    <audio controls class="w-100">
        <source src="@Model.AudioFileURL" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
</div>

<div class="subscription-status mb-4">
    @if (ViewBag.IsSubscribed != null && ViewBag.IsSubscribed)
    {
        <p class="text-success">✅ You are subscribed to this podcast.</p>
    }
    else
    {
        <form asp-controller="Listener" asp-action="Subscribe" asp-route-podcastId="@Model.PodcastID" method="post">
            @* Hidden input to allow the controller to redirect back to this page correctly *@
            <input type="hidden" name="EpisodeId" value="@Model.EpisodeID" />
            <button type="submit" class="btn btn-primary">Subscribe to @Model.Podcast.Title</button>
        </form>
    }
</div>

<hr />

@await Html.PartialAsync("_CommentSection", Model)

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}